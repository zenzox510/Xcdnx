<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Zaynix — Upload to Supabase</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <div class="container">
    <h1>Zaynix — Upload (Supabase)</h1>
    <form id="uploadForm">
      <div class="dropzone" id="dropzone">Drop files here or click to select</div>
      <input type="file" id="fileInput" name="file" multiple style="display:none">
      <button type="submit">Upload</button>
    </form>
    <div id="status"></div>
    <h2>Recently uploaded</h2>
    <div id="recent"></div>
  </div>

  <script>
    const drop = document.getElementById('dropzone');
    const fileInput = document.getElementById('fileInput');
    const form = document.getElementById('uploadForm');
    const status = document.getElementById('status');
    const recent = document.getElementById('recent');

    drop.addEventListener('click', ()=>fileInput.click());
    drop.addEventListener('dragover', (e)=>{ e.preventDefault(); drop.classList.add('hover'); });
    drop.addEventListener('dragleave', ()=>drop.classList.remove('hover'));
    drop.addEventListener('drop', (e)=>{ e.preventDefault(); drop.classList.remove('hover'); fileInput.files = e.dataTransfer.files; });

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const files = fileInput.files;
      if (!files || files.length===0) return alert('Choose a file');
      for (const f of files) {
        await uploadFile(f);
      }
      loadRecent();
    });

    async function uploadFile(file) {
      const fd = new FormData();
      fd.append('file', file);
      status.textContent = 'Uploading ' + file.name;
      try {
        const res = await fetch('/api/upload', { method: 'POST', body: fd });
        const data = await res.json();
        if (!res.ok) throw data;
        const url = data.url;
        status.innerHTML = `Uploaded <a href="${url}" target="_blank">${file.name}</a> — <input readonly value="${url}" onclick="this.select()">`;
      } catch (err) {
        status.textContent = 'Upload failed: ' + (err?.error || JSON.stringify(err));
      }
    }

    async function loadRecent() {
      try {
        const res = await fetch('/files');
        const html = await res.text();
        recent.innerHTML = html;
      } catch (err) {
        recent.textContent = 'Failed to load recent';
      }
    }

    loadRecent();
  </script>
</body>
</html>
